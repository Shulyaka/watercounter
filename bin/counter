#!/bin/sh

NAME="$1"
FUNCTION="$2"
shift 2

RRDDIR="/tmp/rrd/$(uname -n)/exec-watercounter"

case "$FUNCTION" in
	get)
		if [ -f "$RRDDIR/counter-${NAME}.rrd" ]; then
			VALUE1="$(rrdtool info "$RRDDIR/counter-${NAME}.rrd" |grep last_ds | sed -e 's/^.*last_ds = "\(.*\)"/\1/')"
		fi

		VALUE2="$(cat /etc/watercounter/counter*_${NAME})"

		if [ -n "$VALUE1" -a "$VALUE1" != "UNKN" -a "$VALUE1" -gt "$VALUE2" ]; then
			echo "$VALUE1"
		else
			echo "$VALUE2"
		fi

		;;
	set)
		PID="$(pidof watercounter)"
		FILE="$(basename /etc/watercounter/counter*_${NAME})"
		GPIO="${FILE#counter}"
		GPIO="${GPIO%%_*}"

		if [ -z "$1" ]; then
			echo "$0: New value required" >&2
			exit 1
		fi

		if [ -f "$RRDDIR/counter-${NAME}.rrd" ]; then
			VALUE1="$(rrdtool info "$RRDDIR/counter-${NAME}.rrd" |grep last_ds | sed -e 's/^.*last_ds = "\(.*\)"/\1/')"
		fi

		VALUE2="$(cat /etc/watercounter/counter*_${NAME})"

		if [ -n "$VALUE1" -a "$VALUE1" != "UNKN" ]; then
			VALUE=$(($1 - $VALUE1))
		else
			VALUE=$(($1 - $VALUE2))
		fi

		if [ -n "$PID" ]; then
			for P in $PID; do
				watercounter "$P" "$GPIO" "$VALUE"
			done
		fi

		if [ -z "$PID" -o "$1" -lt "$VALUE2" ]; then
			echo "$1" > /etc/watercounter/"$FILE"
		fi

		;;
	*)
		echo "$0: Unknown function $FUNCTION" >&2
		;;
esac

