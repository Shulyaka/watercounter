#!/bin/sh

NAME="$1"
FUNCTION="$2"
shift 2

RRDDIR="/tmp/rrd/$(uname -n)/exec-watercounter"

case "$FUNCTION" in
	get)
		if [ -f "$RRDDIR/counter-${NAME}.rrd" ]; then
			VALUE1="$(rrdtool info "$RRDDIR/counter-${NAME}.rrd" |grep last_ds | sed -e 's/^.*last_ds = "\(.*\)"/\1/')"
		fi

		VALUE2="$(cat /etc/watercounter/counter*_${NAME})"

		if [ -n "$VALUE1" -a "$VALUE1" != "UNKN" -a "$VALUE1" -gt "$VALUE2" ]; then
			echo "$VALUE1"
		else
			echo "$VALUE2"
		fi

		;;
	set)
		PID="$(pidof watercounter)"
		VALUE="$1"

		if [ -n "$PID" ]; then
			#kill -s 42 -q $((($NAME<<24)+$VALUE)) "$PID"
			watercounter "$PID" "$NAME" "$VALUE"
		else
			echo "$VALUE" > /etc/watercounter/counter${NAME}_*
		fi

		;;
	*)
		echo "$0: Unknown function $FUNCTION" >&2
		;;
esac

